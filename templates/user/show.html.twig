{% extends 'base.html.twig' %}

{% block title %}{{ user.username }}'s Perfil{% endblock %}

{% block body %}
    {% set isOwnProfile = app.user and app.user.id == user.id %}
    {% set isFollowing = not isOwnProfile and user.followers|filter(f => f == app.user)|length > 0 %}
    
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                
                <div class="card shadow-sm border-0" style="background: white; border: 1px solid var(--instagram-border, #dbdbdb);">
                    <div class="card-body p-5">
                        
                        {# --- TÍTULO DINÁMICO --- #}
                        <h1 class="card-title text-center mb-5 fw-bold" style="color: #262626;">
                            <i class="bi bi-person-circle me-2"></i> 
                            {% if isOwnProfile %}
                                Tu Perfil
                            {% else %}
                                Perfil de Usuario
                            {% endif %}
                        </h1>
                        
                        {# --- Sección de Cabecera del Perfil --- #}
                        <div class="d-flex flex-column align-items-center text-center mb-4">
                            {# Imagen de Perfil #}
                            {% set avatarUrl = user.picture ? asset('img/' ~ user.picture) : asset('img/default-avatar.png') %}
                            
                            <div class="story-ring mb-3" 
                                style="
                                    /* El borde degradado de tus historias para el avatar */
                                    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
                                    width: 160px; height: 160px; padding: 5.5px; border-radius:50%;
                                    {% if not isOwnProfile %}
                                        /* Si no es tu perfil, el borde es sólido y discreto */
                                        background: var(--instagram-border, #dbdbdb); 
                                    {% endif %}
                                "
                            >
                                <img 
                                    src="{{ avatarUrl }}" 
                                    alt="{{ user.username }}" 
                                    class="rounded-circle" 
                                    style="width: 150px; height: 150px; object-fit: cover; border: 4px solid white;"
                                >
                            </div>
                            
                            {# Nombre de Usuario #}
                            <h3 class="fw-bold mb-1" style="color: #262626;">{{ user.username }}</h3>
                            
                            {# --- Botón de FOLLOW / FOLLOWING DINÁMICO (SOLO SI NO ES TU PERFIL) --- #}
                            {% if not isOwnProfile and app.user %}
                                <a href="{{ isFollowing 
                                            ? path('app_user_unfollow', {'id': user.id}) 
                                            : path('app_user_follow', {'id': user.id}) }}" 
                                    class="btn btn-sm fw-bold mt-2 {{ isFollowing ? 'btn-following-ig' : 'btn-follow-ig' }}"
                                    style="width: 180px; font-size: 14px;">
                                    {{ isFollowing ? 'Following' : 'Follow' }}
                                </a>
                            {% endif %}
                            
                        </div>
                        
                        {# --- Estadísticas de Seguidores/Siguiendo --- #}
                        <div class="d-flex justify-content-center gap-5 mb-4 border-top pt-3" style="border-color: var(--instagram-border) !important;">
                            <div class="text-center">
                                <a href="{{ path('app_user_followers', {'id': user.id}) }}" class="text-decoration-none text-dark">
                                    <span class="d-block fw-bold fs-5">{{ user.getFollowers()|length }}</span>
                                    <span class="text-muted" style="font-size: 14px;">Followers</span>
                                </a>
                            </div>
                            
                            <div class="text-center">
                                <a href="{{ path('app_user_following', {'id': user.id}) }}" class="text-decoration-none text-dark">
                                    <span class="d-block fw-bold fs-5">{{ user.getFollowing()|length }}</span>
                                    <span class="text-muted" style="font-size: 14px;">Following</span>
                                </a>
                            </div>
                        </div>

                        {# --- Botones de Acción (Editar y Eliminar, SOLO PARA TU PERFIL) --- #}
                        <div class="d-grid gap-2 mb-4">
                            {% if isOwnProfile %}
                                <a href="{{ path('app_user_edit', {'id': user.id}) }}" class="btn btn-lg fw-bold" style="
                                    background: white; 
                                    color: #262626;
                                    border: 1px solid var(--instagram-border, #dbdbdb);
                                ">
                                    <i class="bi bi-gear-fill me-2"></i> Editar Perfil
                                </a>
                            {% endif %}
                        </div>

                        <hr style="border-color: var(--instagram-border);">
                        
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <hr style="border-color: var(--instagram-border);" class="my-4">

    {# Tabs para Posts y Reposts #}
    <div class="container">
        <ul class="nav nav-tabs justify-content-center mb-4" id="profileTabs" role="tablist" style="border-bottom: 1px solid var(--instagram-border);">
            <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts" type="button" role="tab" style="color: #262626; border: none;">
                    <i class="bi bi-grid-3x3-gap me-2"></i>Posts
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold" id="reposts-tab" data-bs-toggle="tab" data-bs-target="#reposts" type="button" role="tab" style="color: #8e8e8e; border: none;">
                    <i class="bi bi-repeat me-2"></i>Reposts
                </button>
            </li>
        </ul>

        <div class="tab-content" id="profileTabsContent">
            {# TAB DE POSTS ORIGINALES #}
            <div class="tab-pane fade show active" id="posts" role="tabpanel">
                <div class="row g-3">
                    {% for post in user.getPosts()|filter(p => p.originalPost is null and p.deletedAt is null) %}
                        <div class="col-md-6 col-lg-4">
                            <div class="post-card-profile" style="
                                background: white;
                                border: 1px solid var(--instagram-border, #dbdbdb);
                                border-radius: 8px;
                                overflow: hidden;
                                transition: transform 0.2s, box-shadow 0.2s;
                                height: 100%;
                                display: flex;
                                flex-direction: column;
                            ">
                                
                                {# Imagen del post si existe #}
                                {% if post.img %}
                                    <div style="
                                        width: 100%;
                                        height: 280px;
                                        overflow: hidden;
                                        background: #f5f5f5;
                                    ">
                                        <img src="{{ asset('img/' ~ post.img) }}" 
                                            alt="Post image"
                                            style="
                                                width: 100%;
                                                height: 100%;
                                                object-fit: cover;
                                                transition: transform 0.3s;
                                            "
                                            onmouseover="this.style.transform='scale(1.05)'"
                                            onmouseout="this.style.transform='scale(1)'">
                                    </div>
                                {% endif %}

                                <div class="card-body p-3 d-flex flex-column" style="flex: 1;">
                                    <p class="card-text mb-2" style="
                                        color: #262626;
                                        font-size: 14px;
                                        line-height: 1.4;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        display: -webkit-box;
                                        -webkit-line-clamp: 3;
                                        -webkit-box-orient: vertical;
                                    ">{{ post.text }}</p>

                                    <div class="mt-auto">
                                        <small class="text-muted d-block mb-2" style="font-size: 12px;">
                                            <i class="bi bi-clock me-1"></i>{{ post.postdate|date('d/m/Y H:i') }}
                                        </small>

                                        <a href="{{ path('app_post_show', {'id': post.id}) }}" 
                                            class="btn btn-sm w-100 fw-bold" 
                                            style="
                                                background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
                                                color: white;
                                                border: none;
                                                font-size: 13px;
                                                padding: 8px;
                                                transition: opacity 0.2s;
                                            "
                                            onmouseover="this.style.opacity='0.85'"
                                            onmouseout="this.style.opacity='1'">
                                            <i class="bi bi-eye me-1"></i>Ver Post
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-12">
                            <div class="text-center py-5" style="
                                background: white;
                                border: 1px solid var(--instagram-border, #dbdbdb);
                                border-radius: 8px;
                            ">
                                <i class="bi bi-camera" style="font-size: 48px; color: #8e8e8e;"></i>
                                <p class="text-muted mt-3 mb-0">Este usuario no tiene posts todavía.</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            {# TAB DE REPOSTS #}
            <div class="tab-pane fade" id="reposts" role="tabpanel">
                <div class="row g-3">
                    {% for repost in user.getPosts()|filter(p => p.originalPost is not null and p.deletedAt is null) %}
                        {% set originalPost = repost.originalPost %}
                        <div class="col-md-6 col-lg-4">
                            <div class="post-card-profile" style="
                                background: white;
                                border: 1px solid var(--instagram-border, #dbdbdb);
                                border-radius: 8px;
                                overflow: hidden;
                                transition: transform 0.2s, box-shadow 0.2s;
                                height: 100%;
                                display: flex;
                                flex-direction: column;
                            ">
                                {# Indicador de repost #}
                                <div class="px-3 pt-3 pb-2" style="background: #fafafa; border-bottom: 1px solid var(--instagram-border);">
                                    <small class="text-muted d-flex align-items-center" style="font-size: 12px;">
                                        <i class="bi bi-repeat me-2" style="color: #00ba7c;"></i>
                                        <strong>{{ user.username }}</strong>&nbsp;reposteó
                                    </small>
                                </div>

                                {# Imagen del post original #}
                                {% if originalPost.img %}
                                    <div style="
                                        width: 100%;
                                        height: 280px;
                                        overflow: hidden;
                                        background: #f5f5f5;
                                    ">
                                        <img src="{{ asset('img/' ~ originalPost.img) }}" 
                                            alt="Post image"
                                            style="
                                                width: 100%;
                                                height: 100%;
                                                object-fit: cover;
                                                transition: transform 0.3s;
                                            "
                                            onmouseover="this.style.transform='scale(1.05)'"
                                            onmouseout="this.style.transform='scale(1)'">
                                    </div>
                                {% endif %}

                                <div class="card-body p-3 d-flex flex-column" style="flex: 1;">
                                    {# Autor original #}
                                    <div class="d-flex align-items-center mb-2">
                                        {% set originalAuthorAvatar = originalPost.author.picture ? asset('img/' ~ originalPost.author.picture) : asset('img/default-avatar.png') %}
                                        <img src="{{ originalAuthorAvatar }}" 
                                            alt="{{ originalPost.author.username }}"
                                            class="rounded-circle me-2"
                                            style="width: 24px; height: 24px; object-fit: cover;">
                                        <small class="fw-bold" style="color: #262626; font-size: 13px;">
                                            {{ originalPost.author.username }}
                                        </small>
                                    </div>

                                    <p class="card-text mb-2" style="
                                        color: #262626;
                                        font-size: 14px;
                                        line-height: 1.4;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        display: -webkit-box;
                                        -webkit-line-clamp: 3;
                                        -webkit-box-orient: vertical;
                                    ">{{ originalPost.text }}</p>

                                    <div class="mt-auto">
                                        <small class="text-muted d-block mb-2" style="font-size: 12px;">
                                            <i class="bi bi-clock me-1"></i>{{ repost.postdate|date('d/m/Y H:i') }}
                                        </small>

                                        <a href="{{ path('app_post_show', {'id': originalPost.id}) }}" 
                                            class="btn btn-sm w-100 fw-bold" 
                                            style="
                                                background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
                                                color: white;
                                                border: none;
                                                font-size: 13px;
                                                padding: 8px;
                                                transition: opacity 0.2s;
                                            "
                                            onmouseover="this.style.opacity='0.85'"
                                            onmouseout="this.style.opacity='1'">
                                            <i class="bi bi-eye me-1"></i>Ver Post
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-12">
                            <div class="text-center py-5" style="
                                background: white;
                                border: 1px solid var(--instagram-border, #dbdbdb);
                                border-radius: 8px;
                            ">
                                <i class="bi bi-repeat" style="font-size: 48px; color: #8e8e8e;"></i>
                                <p class="text-muted mt-3 mb-0">Este usuario no ha hecho reposts todavía.</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

{% endblock %}